<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Sharefest</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Courgette' rel='stylesheet' type='text/css'>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/sfClient.js"></script>
    <script src="js/peerConnectionImplChrome.js"></script>
    <script src="js/test_functions.js"></script>
    <script src="js/util.js"></script>
    <script src="js/p2p_proto.js"></script>
    <script src="shared/radio.min.js"></script>
    <script src="js/peerConnectionImplFirefox.js"></script>
    <script src="shared/protocol.js"></script>
    <script type="text/javascript" src="./socket.io/socket.io.js"></script>
    <script src="js/wsConnection.js"></script>
    <script src="js/base64-arraybuffer.js"></script>
    <script src="js/apiValidator.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var validator = new ApiValidator();
            if (!validator.validateBrowser()) {
                document.location = '/browser';
                return;
            }

            sharefestClient = new client('ws://' + window.location.hostname);

            radio('receivedRoomMetadata').subscribe([function (room_files) {
                updateList(room_files);
            }, null]);

            radio('downloadProgress').subscribe([function (percent, bw, totalBW) {
                var prog = document.getElementById('progress');
                var progDiv = document.getElementById('progressbar');
                var per = document.getElementById('percent');
                var rateDiv = document.getElementById('rate');
                var bwPresenter = document.getElementById('bandwidthPresenter');
                if (bw) {
                    if (bw >= 1024) {
                        rateDiv.textContent = (((bw / 1024).toFixed(1))).toString() + 'MByte|sec';
                    } else {
                        rateDiv.textContent = (((bw).toFixed(1))).toString() + 'KByte|sec';
                    }
                }

                if (totalBW) {
                    bwPresenter.textContent = 'Total Download Bandwidth';
                    if (totalBW >= 1024) {
                        rateDiv.textContent = (((totalBW / 1024).toFixed(1))).toString() + 'MByte|sec';
                    } else {
                        rateDiv.textContent = (((totalBW).toFixed(1))).toString() + 'KByte|sec';
                    }

                }

                if (prog.hidden) {
                    prog.hidden = false;
                    progDiv.hidden = false;
                }

                prog.value = percent;
                per.textContent = Math.floor(percent.toString()) + '%';


            }, null]);
        });

        function updateList(files) {
            $('#box-text').text(listFiles(files));
            $('.dragdrop').css('opacity', 0.95);
        }
        function addFiles(files) {
            var file = files[0]; // FileList object
            var reader = new FileReader();
            reader.onload = (function (theFile) {
                return function (e) {
                    sharefestClient.addFile(e.target.result);
                    updateList(files);

                    //TODO: fix for multiple files
                    meta0 = {};
                    meta0.numOfChunks = sharefestClient.numOfChunksInFile;
                    meta0.size = files[0].size;
                    meta0.name = files[0].name;
                    meta0.lastModifiedDate = files[0].lastModifiedDate;
                    meta0.type = files[0].type;
                    sharefestClient.ws.upload([meta0]);
                };
            })(file);
            reader.readAsDataURL(file);
        }

        function listFiles(files) {
            var str = '';
            for (var i = 0; i < files.length; i++) {
                var entry = files[i];
                str += entry.name + ' ' + bytesToSize(entry.size) + '\n';
            }
            return str;
        }
    </script>
    <style>
        body {
            padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
            font-family: "Courgette";
        }

        .text-pretty {
            font-size: 1.5em;
        }

        h3 {
            font-size: 24px;
        }

        h1 {
            font-family: 'Courgette', 'IM Fell English', serif;
            font-size: 5em;
        }

        .dragdrop {
            padding-top: 260px;
            width: 900px;
            height: 400px;
            border: solid #000000;
            line-height: 50px;
            text-align: center;
            font-weight: bold;
            background-color: #FFFFFF;
            opacity: 0.8;

        }

        .bg {
            background-image: url('img/1.jpg');
        }

        .info {
            right: 10px;
            float: right;
            clear: both;
            bottom: 10px;
            position: absolute;
        }

    </style>
    <script type="text/javascript" src="js/dnd.js"></script>
</head>
<body class="bg">
<a href="https://github.com/peer5/sharefest"><img style="position: absolute; top: 0; right: 0; border: 0; z-index:9999"
                                                  src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"
                                                  alt="Fork me on GitHub"></a>

<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <div class="nav-collapse collapse">
                <ul class="nav">
                    <li class="active"><a href="/">Sharefest</a></li>
                    <li><a href="/about">About</a></li>
                    <li><a href="/contact">Contact</a></li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </div>
</div>

<div class="container">
    <h1></h1>

    <div class="dragdrop text-pretty" id="dropbox" onClick="$('#files').click()">
        <canvas id="cnvs" style="height: 0px"></canvas>
        <div><img id="logo" src="img/logo.png"/>
            <br/>
            <span id='box-text'>Just drag any file here, and start sharing immediately!</span>

        <span id="progressbar" hidden="true">
            <progress id="progress" hidden="true" value="0" max="100"></progress>
            <p id="percent" style="display: inline;"></p>
            </br>
            <p id="bandwidthPresenter" style="display: inline;">Download Rate: </p>
            <p id="rate" style="display: inline;"></p>

        </span>
        </div>

        <!--<p class="info">For more info about Sharefest, go to our-->
        <!--<a href="http://github.com/peer5/sharefest">project page</a></p>-->
    </div>

    <input onchange="addFiles(this.files)" type="file" id="files" name="files[]" multiple
           style="height: 20px; opacity: 0; filter:alpha(opacity: 0);  position: relative; top: -40px; left: -20px;"/>

</div>

<!--<div id="tt" style="position: absolute; left: 50px; bottom: 50px; font-size: 5em;">0</div>-->
<!-- /container -->
</body>
</html>